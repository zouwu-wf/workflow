# åˆ‡æ¢å½“å‰æ–‡ä»¶å¤¹å·¥ä½œæµ
# è‡ªåŠ¨è·å–æ–‡ä»¶å¤¹é…ç½®å¹¶æ›´æ–° appState

id: "switch_current_folder"
name: "åˆ‡æ¢å½“å‰æ–‡ä»¶å¤¹"
description: "åˆ‡æ¢å½“å‰æ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨è·å–.photasa.jsoné…ç½®å¹¶æ›´æ–°appState"
version: "1.0.0"
author: "Tianshu Engine"
createdAt: 1729267200000
updatedAt: 1729267200000

# è§¦å‘æ¡ä»¶
triggers:
    - intent: "switch_current_folder"
    - intent: "folder_switch"

# è¾“å…¥å‚æ•°
inputs:
    folder:
        type: "string"
        required: true
        description: "ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„"
    source:
        type: "string"
        required: false
        default: "user_action"
        description: "åˆ‡æ¢æ¥æºæ ‡è¯†"

# å·¥ä½œæµæ­¥éª¤
steps:
    # 1ï¸âƒ£ éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„
    - id: "validate_folder"
      name: "éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„"
      type: "builtin"
      action: "validate"
      description: "éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„æ ¼å¼"
      input:
          value: "{{inputs.folder}}"
          rules:
              - type: "string"
              - notEmpty: true
              - minLength: 1
      output_schema:
          valid:
              type: boolean
          errors:
              type: array
              items:
                  type: string

    # 2ï¸âƒ£ æ£€æŸ¥éªŒè¯ç»“æœ
    - id: "check_validation"
      name: "æ£€æŸ¥éªŒè¯ç»“æœ"
      type: "condition"
      description: "éªŒè¯é€šè¿‡æ‰ç»§ç»­æ‰§è¡Œ"
      dependsOn: ["validate_folder"]
      condition:
          field: "{{steps.validate_folder.valid}}"
          operator: "eq"
          value: true
      onTrue: [] # ç»§ç»­åç»­æ­¥éª¤
      onFalse:
          - id: "return_validation_error"
            name: "è¿”å›éªŒè¯é”™è¯¯"
            type: "builtin"
            action: "return"
            input:
                success: false
                error: "æ–‡ä»¶å¤¹è·¯å¾„éªŒè¯å¤±è´¥"
                details: "{{steps.validate_folder.errors}}"

    # 3ï¸âƒ£ è°ƒç”¨å¸ç°¿å¼•æ“è·å–æ–‡ä»¶å¤¹é…ç½®
    - id: "get_folder_config"
      name: "è·å–æ–‡ä»¶å¤¹é…ç½®"
      type: "action"
      description: "è°ƒç”¨å¸ç°¿å¼•æ“è¯»å–.photasa.jsoné…ç½®"
      service: "taiyi"
      action: "callEngine"
      dependsOn: ["check_validation"]
      input:
          engineName: "sibu"
          methodName: "readFolderConfig"
          params:
              - "{{inputs.folder}}"
      # å¸ç°¿å¼•æ“è¿”å›ç»“æ„
      output_schema:
          result:
              type: object
              properties:
                  config:
                      type: object
                      description: "PhotasaConfigå¯¹è±¡æˆ–null"
                  exists:
                      type: boolean
                      description: "é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨"

    # 4ï¸âƒ£ è®°å½•é…ç½®è·å–ç»“æœ
    - id: "log_config_result"
      name: "è®°å½•é…ç½®è·å–ç»“æœ"
      type: "builtin"
      action: "log"
      dependsOn: ["get_folder_config"]
      input:
          level: "info"
          message: "ğŸ”§ æ–‡ä»¶å¤¹é…ç½®è¯»å–å®Œæˆ: {{inputs.folder}} (å­˜åœ¨: {{steps.get_folder_config.result.exists}})"

    # 5ï¸âƒ£ æ„é€  appState delta
    - id: "build_appstate_delta"
      name: "æ„é€ appStateæ›´æ–°æ•°æ®"
      type: "builtin"
      action: "transform"
      description: "æ„é€ åŒ…å«folderå’Œconfigçš„å®Œæ•´delta"
      dependsOn: ["log_config_result"]
      input:
          data:
              appState:
                  currentFolder: "{{inputs.folder}}"
                  currentFolderConfig: "{{steps.get_folder_config.result.config}}"
      output_schema:
          type: object
          properties:
              appState:
                  type: object

    # 6ï¸âƒ£ è°ƒç”¨å¸å‘½å¼•æ“æ›´æ–° appState
    - id: "update_appstate"
      name: "æ›´æ–°appState"
      type: "action"
      description: "è°ƒç”¨å¸å‘½å¼•æ“æŒä¹…åŒ–appState"
      service: "taiyi"
      action: "callEngine"
      dependsOn: ["build_appstate_delta"]
      input:
          engineName: "siming"
          methodName: "updateAppState"
          params:
              - "{{steps.build_appstate_delta.appState}}"
      # å¸å‘½å¼•æ“è¿”å›ç»“æ„
      output_schema:
          result:
              type: object
              description: "æ›´æ–°åçš„å®Œæ•´appState"

    # 7ï¸âƒ£ è®°å½•æ›´æ–°ç»“æœ
    - id: "log_update_result"
      name: "è®°å½•æ›´æ–°ç»“æœ"
      type: "builtin"
      action: "log"
      dependsOn: ["update_appstate"]
      input:
          level: "info"
          message: "ğŸ”§ appStateå·²æ›´æ–°: currentFolder={{inputs.folder}}, configå­˜åœ¨={{steps.get_folder_config.result.exists}}"

    # 8ï¸âƒ£ æ ¼å¼åŒ–è¿”å›ç»“æœ
    - id: "format_response"
      name: "æ ¼å¼åŒ–è¿”å›ç»“æœ"
      type: "builtin"
      action: "return"
      dependsOn: ["log_update_result"]
      input:
          success: true
          data:
              # è¿”å›å®Œæ•´çš„ appState deltaï¼ˆä¾›æˆ¿ç„é¾„åŒæ­¥Storeï¼‰
              appState:
                  currentFolder: "{{inputs.folder}}"
                  currentFolderConfig: "{{steps.get_folder_config.result.config}}"
              # é¢å¤–å…ƒæ•°æ®
              metadata:
                  configExists: "{{steps.get_folder_config.result.exists}}"
                  source: "{{inputs.source}}"
          timestamp: "{{now()}}"

# è¾“å‡ºå®šä¹‰
outputs:
    success:
        description: "åˆ‡æ¢æ˜¯å¦æˆåŠŸ"
        type: "boolean"
    data:
        description: "appState deltaå¯¹è±¡"
        type: "object"
        properties:
            appState:
                type: object
                properties:
                    currentFolder:
                        type: string
                    currentFolderConfig:
                        type: object
    timestamp:
        description: "æ“ä½œæ—¶é—´æˆ³"
        type: "number"

# é”™è¯¯å¤„ç†
error_handling:
    validation_error:
        type: "return_error"
        response:
            success: false
            error: "æ–‡ä»¶å¤¹è·¯å¾„éªŒè¯å¤±è´¥"
            details: "{{ error.details }}"

    sibu_error:
        type: "graceful_failure" # é…ç½®è¯»å–å¤±è´¥ä¸ç®—é”™è¯¯ï¼Œè¿”å›null
        response:
            success: true
            data:
                appState:
                    currentFolder: "{{ inputs.folder }}"
                    currentFolderConfig: null
                metadata:
                    configExists: false
                    error: "é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥"
            timestamp: "{{now()}}"

    siming_error:
        type: "return_error"
        response:
            success: false
            error: "appStateæŒä¹…åŒ–å¤±è´¥"
            reason: "{{ error.message }}"

# è¶…æ—¶è®¾ç½®
timeout: 10000
priority: "user"
