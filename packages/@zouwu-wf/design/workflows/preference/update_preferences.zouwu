# æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®å·¥ä½œæµ
# é€šè¿‡æ–‡æ˜Œå¼•æ“æ›´æ–°åå¥½è®¾ç½®å¹¶å¹¿æ’­å˜æ›´

id: "update_preferences"
name: "æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®"
description: "æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®"
version: "1.0.0"
author: "Tianshu Engine"
createdAt: 1727544000000
updatedAt: 1727544000000

# è§¦å‘æ¡ä»¶
triggers:
    - intent: "update_preferences"
    - intent: "preference_update"

# è¾“å…¥å‚æ•°
inputs:
    delta:
        type: "object"
        required: true
        description: "è¦æ›´æ–°çš„åå¥½è®¾ç½®å¢é‡å¯¹è±¡"
    source:
        type: "string"
        required: false
        default: "user_action"
        description: "æ›´æ–°æ¥æºæ ‡è¯†"

# å·¥ä½œæµæ­¥éª¤
steps:
    - id: "validate_delta"
      name: "éªŒè¯åå¥½æ›´æ–°æ•°æ®"
      type: "action"
      description: "éªŒè¯åå¥½æ›´æ–°æ•°æ®"
      service: "wenchang"
      action: "validate"
      input:
          delta: "{{inputs.delta}}"
          rules:
              - type: "object"
              - notEmpty: true
              # âœ… RFC 0038: pathOperationså·²åˆ é™¤ï¼Œè·¯å¾„æ“ä½œé€šè¿‡scanning.pathså­—æ®µå¤„ç†
              - allowedKeys: ["ui", "display", "scanning", "performance", "system"]
      # å£°æ˜é€‚é…å™¨è¿”å›ç»“æ„ï¼Œä½¿å·¥ä½œæµè‡ªè§£é‡Š
      # ä½¿ç”¨JSON Schemaæ ‡å‡†æ ¼å¼æè¿°æ•°ç»„ç±»å‹
      output_schema:
          type: object
          properties:
              valid:
                  type: boolean
              errors:
                  type: array
                  items:
                      type: string

    - id: "simple_test"
      name: "ç®€å•æµ‹è¯•æ­¥éª¤"
      type: "builtin"
      action: "log"
      input:
          level: "info"
          message: "ğŸ¯ ç®€å•æµ‹è¯•æ­¥éª¤æ‰§è¡Œäº†ï¼"
      dependsOn: ["validate_delta"]

    - id: "check_validation"
      name: "check_validation"
      type: "condition"
      description: "æ ¹æ®éªŒè¯ç»“æœå†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œ"
      dependsOn: ["simple_test"]
      condition:
          # è®¿é—®validateæ­¥éª¤è¿”å›çš„validå­—æ®µ
          field: "{{steps.validate_delta.valid}}"
          operator: "eq"
          value: true
      onTrue: [] # éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
      onFalse:
          - id: "return_validation_error"
            name: "return_validation_error"
            type: "builtin"
            action: "return"
            input:
                success: false
                error: "åå¥½è®¾ç½®æ•°æ®éªŒè¯å¤±è´¥"
                # è®¿é—®validateæ­¥éª¤è¿”å›çš„errorså­—æ®µ
                details: "{{steps.validate_delta.errors}}"

    - id: "sanitize_values"
      name: "æ¸…ç†å’ŒéªŒè¯åå¥½å€¼"
      type: "action"
      description: "æ¸…ç†å’ŒéªŒè¯åå¥½å€¼"
      service: "wenchang"
      action: "sanitize"
      input:
          source: "{{inputs.delta}}"
          rules:
              ui.theme:
                  type: "string"
                  minLength: 1
                  default: "solarized-dark"
              ui.language:
                  type: "string"
                  pattern: "^[a-z]{2}-[A-Z]{2}$"
                  default: "zh-CN"
              display.thumbnailSize:
                  type: "number"
                  min: 50
                  max: 500
                  default: 150
              display.viewMode:
                  type: "enum"
                  values: ["grid", "list", "timeline"]
                  default: "grid"
              # âœ… RFC 0038: pathOperationså·²åˆ é™¤
              # è·¯å¾„æ“ä½œç°åœ¨é€šè¿‡scanning.pathså­—æ®µç›´æ¥å¤„ç†ï¼Œç”±æˆ¿ç„é¾„è´Ÿè´£ä¸šåŠ¡é€»è¾‘
              scanning.paths:
                  type: "array"
                  required: false
                  items:
                      type: "string"
      # å£°æ˜é€‚é…å™¨è¿”å›ç»“æ„ï¼Œä½¿å·¥ä½œæµè‡ªè§£é‡Š
      # sanitizeç›´æ¥è¿”å›sanitizedDataå¯¹è±¡ï¼Œä¸åŒ…è£…åœ¨resultä¸­
      output_schema:
          type: object # sanitizedDataçš„ç»“æ„
      dependsOn: ["check_validation"]

    - id: "update_engine"
      name: "è°ƒç”¨æ–‡æ˜Œå¼•æ“æ›´æ–°åå¥½"
      type: "action"
      description: "è°ƒç”¨æ–‡æ˜Œå¼•æ“æ›´æ–°åå¥½"
      service: "wenchang"
      action: "updatePreferences"
      input:
          # è®¿é—®sanitize_valuesæ­¥éª¤è¿”å›çš„sanitizedData
          delta: "{{steps.sanitize_values}}"
          source: "{{inputs.source}}"
      output:
          result: "result"
      dependsOn: ["sanitize_values"]

    # âœ… RFC 0038: handle_path_operationsæ­¥éª¤å·²åˆ é™¤
    # pathOperationsä¸å†å­˜åœ¨ï¼Œè·¯å¾„æ“ä½œé€šè¿‡scanning.pathså­—æ®µç»Ÿä¸€å¤„ç†
    # æ‰€æœ‰åå¥½å˜æ›´ï¼ˆåŒ…æ‹¬è·¯å¾„ï¼‰éƒ½é€šè¿‡åŒä¸€ä¸ªæµç¨‹ï¼švalidate -> sanitize -> updatePreferences

    - id: "get_updated_snapshot"
      name: "è·å–æ›´æ–°åçš„åå¥½å¿«ç…§"
      type: "action"
      description: "è·å–æ›´æ–°åçš„åå¥½å¿«ç…§"
      service: "wenchang"
      action: "getCurrentSnapshot"
      input: {}
      # å£°æ˜é€‚é…å™¨è¿”å›ç»“æ„ï¼Œä½¿å·¥ä½œæµè‡ªè§£é‡Š
      # getCurrentSnapshotç›´æ¥è¿”å›{ data, revision, timestamp }
      output_schema:
          data: object
          revision: number
          timestamp: number
      # âœ… RFC 0038: ä¾èµ–æ”¹ä¸ºupdate_engineï¼Œå› ä¸ºhandle_path_operationså·²åˆ é™¤
      dependsOn: ["update_engine"]

    - id: "emit_change_event"
      name: "å‘é€åå¥½å˜æ›´äº‹ä»¶"
      type: "action"
      description: "å‘é€åå¥½å˜æ›´äº‹ä»¶"
      service: "wenchang"
      action: "emitEvent"
      input:
          event: "preferences_changed"
          data:
              # ğŸ¯ ç®€åŒ–è·¯å¾„ï¼šç›´æ¥è®¿é—®å¼•æ“è¿”å›å€¼
              delta: "{{steps.sanitize_values}}"
              snapshot: "{{steps.get_updated_snapshot.data}}"
              source: "{{inputs.source}}"
              timestamp: "{{now()}}"
      output:
          eventId: "id"
      dependsOn: ["get_updated_snapshot"]

    - id: "format_response"
      name: "æ ¼å¼åŒ–è¿”å›ç»“æœ"
      type: "action"
      description: "æ ¼å¼åŒ–è¿”å›ç»“æœ"
      service: "wenchang"
      action: "formatResponse"
      input:
          success: true
          data:
              # ğŸ¯ ç®€åŒ–è·¯å¾„ï¼šç›´æ¥è®¿é—®å¼•æ“è¿”å›å€¼
              updated: "{{steps.sanitize_values}}"
              snapshot: "{{steps.get_updated_snapshot.data}}"
          timestamp: "{{now()}}"
          source: "wenchang_engine"
      output:
          response: "result"
      dependsOn: ["emit_change_event"]

# è¾“å‡ºå®šä¹‰
outputs:
    success:
        description: "æ›´æ–°æ˜¯å¦æˆåŠŸ"
        type: "boolean"
    updated:
        description: "å®é™…æ›´æ–°çš„åå¥½é¡¹"
        type: "object"
    snapshot:
        description: "æ›´æ–°åçš„å®Œæ•´åå¥½å¿«ç…§"
        type: "object"

# é”™è¯¯å¤„ç†
error_handling:
    validation_error:
        type: "return_error"
        response:
            success: false
            error: "åå¥½è®¾ç½®æ•°æ®éªŒè¯å¤±è´¥"
            details: "{{ error.details }}"

    engine_error:
        type: "return_error"
        response:
            success: false
            error: "æ–‡æ˜Œå¼•æ“æ›´æ–°å¤±è´¥"
            reason: "{{ error.message }}"

# è¶…æ—¶è®¾ç½®
timeout: 10000
priority: "user"
